<!DOCTYPE html>
<meta charset="utf-8">
<style>.link {
    fill: none;
    stroke: #666;
    stroke-width: 1.5px;
}

#licensing {
    fill: green;
}

.link.licensing {
    stroke: green;
}

.link.resolved {
    stroke-dasharray: 0, 2 1;
}

circle {
    fill: #ccc;
    stroke: #333;
    stroke-width: 1.5px;
}

text {
    font: 12px Microsoft YaHei;
    pointer-events: none;
    text-shadow: 0 1px 0 #fff, 1px 0 0 #fff, 0 -1px 0 #fff, -1px 0 0 #fff;
}

.linetext {
    font-size: 12px Microsoft YaHei;
}</style>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="iceStone <ice@wedn.net>">
    <title>演示页</title>
    <link rel="shortcut icon" href="../static/favicon.ico">
    <link rel="stylesheet" href="../static/lib/bootstrap/css/bootstrap.css">
    <link rel="stylesheet" href="../static/css/reset.css">
    <link rel="stylesheet" href="../static/css/nav.css">
    <link rel="stylesheet" href="../static/css/footer.css">
    <link rel="stylesheet" href="../static/css/goTop.css">
    <link rel="stylesheet" href="../static/css/main.css">
</head>
<body>
<nav class="navbar navbar-default vivioNav">
    <div class="container" style="background: #101010">
        <div class="navbar-header" >
            {#      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"  aria-expanded="false">#}
            {#        <span class="sr-only">Toggle navigation</span>#}
            {#        <span class="vivio-icon-bt vivio-icon-bar"></span>#}
            {#        <span class="vivio-icon-bt vivio-icon-close"></span>#}
            {#      </button>#}
            <a id="vivio-navbar-brand" href="/"></a>
            <a id="newVersion" href="/" style="color: white">北京邮电大学图虫系统</a>
        </div>
        <div class="collapse navbar-collapse" id="vivio-navbar-collapse">
            <ul class="nav navbar-nav vivio-navbar-nav">
                <li class="active"><a href="/" style="color:#000000">首页 <span class="sr-only">(current)</span></a></li>
                <li id="vivio-product-link">
                    <a style="color:white">核心产品</a>
                    <!-- 产品下拉导航菜单 -->
                    <div class="vivio-product">
                        <div class="vivio-container clearfix" >
                            <dl>
                                <dt>知识图谱</dt>
                                <dt>语义理解</dt>
                                <dt>智能问答</dt>
                            </dl>
                            <dl>
                                <dt>产品1</dt>
                                <dt>产品2</dt>
                                <dt>产品3</dt>
                            </dl>
                        </div>
                    </div>
                    <!-- /产品下拉导航菜单 -->
                </li>
                <li id="vivio-product-link">
                    <a style="color:white">解决方案</a>
                    <div class="vivio-product">
                        <div class="vivio-container clearfix">
                            <dl>
                                <dt>知识抽取技术</dt>
                            </dl>
                            <dl>
                                <dt>中文分词技术</dt>
                            </dl>
                            <dl>
                                <dt>表示学习技术</dt>
                            </dl>
                            <dl>
                                <dt>信任评估算法</dt>
                            </dl>
                        </div>
                    </div>
                </li>
                <li id="vivio-product-link">
                     <a style="color:white" href="/weibo_search">图虫实验室</a>
                    <div class="vivio-product">
                        <div class="vivio-container clearfix">
                            <dl>
                                <dt><a href="/search">实体属性查询</a></dt>
                                <dt><a href="/search">路径搜索模型</a></dt>
                                <dt><a href="/answer">智能问答系统</a></dt>
                                 <dt><a  href="/evaluation">信任评估模型</a></dt>
                            </dl>
                            <dl><dt><a href="/search">nlp分词技术</a></dt>
                                <dt><a href="/search">nlp情感分析</a></dt>
                                <dt><a >关系纠错与补全模型</a></dt>
                                <dt><a >歧义关系查询</a></dt>
                            </dl>
                            <dl>
                                <dt><a href="/demo">DEMO3</a></dt>
                            </dl>
                        </div>
                    </div>
                </li>
                <li><a href="/news" style="color:white">图谱动态</a></li>
                <li><a href="/about" style="color:white">关于我们</a></li>
            </ul>
            {#      <ul class="nav navbar-nav navbar-right hidden-xs">#}
            {#        <li class="nav-t-kefu"><span class="vivio-icon"></span><em>在线客服</em></li>#}
            {#          <li class="nav-t-search"><span class="vivio-icon "></span><em>在线客服</em></li>#}
            {#        <li class="nav-t-userInformation"><span class="vivio-icon"></span></li>#}
            {#      </ul>#}
        </div><!-- /.navbar-collapse -->
    </div><!-- /.container-fluid -->
</nav>
<!-- /导航 -->
<script src="https://d3js.org/d3.v3.min.js"></script>
<script src="http://apps.bdimg.com/libs/jquery/2.1.4/jquery.js"></script>
<script>
    var links = new Array()
    arr = eval({{contents|safe }})
    for (var i = 0; i < arr.length; i++) {
        links.push(arr[i])
    }
    console.log(links)
    var nodes = {};

    links.forEach(function (link) {
        link.source = nodes[link.source] || (nodes[link.source] = {name: link.source});
        link.target = nodes[link.target] || (nodes[link.target] = {name: link.target});
    });

    var width = 1920, height = 1080;

    var force = d3.layout.force()
        .nodes(d3.values(nodes))
        .links(links)
        .size([width, height])
        .linkDistance(180)
        .charge(-1500)
        .on("tick", tick)
        .start();

    var svg = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height);

    var marker =
        svg.append("marker")
            .attr("id", "resolved")
            .attr("markerUnits", "userSpaceOnUse")
            .attr("viewBox", "0 -5 10 10")
            .attr("refX", 32)
            .attr("refY", -1)
            .attr("markerWidth", 12)
            .attr("markerHeight", 12)
            .attr("orient", "auto")
            .attr("stroke-width", 2)
            .append("path")
            .attr("d", "M0,-5L10,0L0,5")
            .attr('fill', '#000000');

    var edges_line = svg.selectAll(".edgepath")
        .data(force.links())
        .enter()
        .append("path")
        .attr({
            'd': function (d) {
                return 'M ' + d.source.x + ' ' + d.source.y + ' L ' + d.target.x + ' ' + d.target.y
            },
            'class': 'edgepath',
            'id': function (d, i) {
                return 'edgepath' + i;
            }
        })
        .style("stroke", function (d) {
            var lineColor;
            lineColor = "#B43232";
            return lineColor;
        })
        .style("pointer-events", "none")
        .style("stroke-width", 0.5)
        .attr("marker-end", "url(#resolved)");

    var edges_text = svg.append("g").selectAll(".edgelabel")
        .data(force.links())
        .enter()
        .append("text")
        .style("pointer-events", "none")
        .attr({
            'class': 'edgelabel',
            'id': function (d, i) {
                return 'edgepath' + i;
            },
            'dx': 80,
            'dy': 0
        });

    edges_text.append('textPath')
        .attr('xlink:href', function (d, i) {
            return '#edgepath' + i
        })
        .style("pointer-events", "none")
        .text(function (d) {
            return d.rela;
        });

    var circle = svg.append("g").selectAll("circle")
        .data(force.nodes())
        .enter().append("circle")
        .style("fill", function (node) {
            var color;
            var link = links[node.index];
            color = "#F9EBF9";
            return color;
        })
        .style('stroke', function (node) {
            var color;
            var link = links[node.index];
            color = "#A254A2";
            return color;
        })
        .attr("r", 28)
        .on("click", function (node) {
            edges_line.style("stroke-width", function (line) {
                console.log(line);
                if (line.source.name == node.name || line.target.name == node.name) {
                    return 4;
                } else {
                    return 0.5;
                }
            });
        })
        .call(force.drag);

    var text = svg.append("g").selectAll("text")
        .data(force.nodes())
        .enter()
        .append("text")
        .attr("dy", ".35em")
        .attr("text-anchor", "middle")
        .style('fill', function (node) {
            var color;
            var link = links[node.index];
            color = "#A254A2";
            return color;
        }).attr('x', function (d) {
            var re_en = /[a-zA-Z]+/g;
            if (d.name.match(re_en)) {
                d3.select(this).append('tspan')
                    .attr('x', 0)
                    .attr('y', 2)
                    .text(function () {
                        return d.name;
                    });
            }

            else if (d.name.length <= 4) {
                d3.select(this).append('tspan')
                    .attr('x', 0)
                    .attr('y', 2)
                    .text(function () {
                        return d.name;
                    });
            } else {
                var top = d.name.substring(0, 4);
                var bot = d.name.substring(4, d.name.length);

                d3.select(this).text(function () {
                    return '';
                });

                d3.select(this).append('tspan')
                    .attr('x', 0)
                    .attr('y', -7)
                    .text(function () {
                        return top;
                    });

                d3.select(this).append('tspan')
                    .attr('x', 0)
                    .attr('y', 10)
                    .text(function () {
                        return bot;
                    });
            }
        });

    function tick() {
        circle.attr("transform", transform1);
        text.attr("transform", transform2);

        edges_line.attr('d', function (d) {
            var path = 'M ' + d.source.x + ' ' + d.source.y + ' L ' + d.target.x + ' ' + d.target.y;
            return path;
        });

        edges_text.attr('transform', function (d, i) {
            if (d.target.x < d.source.x) {
                bbox = this.getBBox();
                rx = bbox.x + bbox.width / 2;
                ry = bbox.y + bbox.height / 2;
                return 'rotate(180 ' + rx + ' ' + ry + ')';
            }
            else {
                return 'rotate(0)';
            }
        });
    }

    function linkArc(d) {
        return 'M ' + d.source.x + ' ' + d.source.y + ' L ' + d.target.x + ' ' + d.target.y
    }

    function transform1(d) {
        return "translate(" + d.x + "," + d.y + ")";
    }

    function transform2(d) {
        return "translate(" + (d.x) + "," + d.y + ")";
    }

</script>


